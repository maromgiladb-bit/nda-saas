/**
 * Script to generate bundled templates for serverless deployments
 * Run with: node scripts/generate-bundled-templates.mjs
 * 
 * This script reads all .hbs template files and embeds them
 * as string constants in a TypeScript file.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.join(__dirname, '..');

const templatesDir = path.join(rootDir, 'templates');
const outputFile = path.join(rootDir, 'src', 'lib', 'bundledTemplates.generated.ts');

// Read the template config
const configPath = path.join(templatesDir, 'template-config.json');
const config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));

// Read all template files
const templates = {};
for (const template of config.templates) {
    const templatePath = path.join(templatesDir, template.templateFile);
    const content = fs.readFileSync(templatePath, 'utf-8');
    templates[template.id] = content;
    console.log(`✅ Loaded: ${template.id} (${content.length} chars)`);
}

// Generate TypeScript file
const output = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
 * Generated by: scripts/generate-bundled-templates.mjs
 * Generated at: ${new Date().toISOString()}
 * 
 * This file contains embedded template content for serverless deployments.
 * Regenerate with: npm run generate-templates
 */

// Template configuration
export const TEMPLATE_CONFIG = ${JSON.stringify(config, null, 2)} as const;

// Embedded template content
export const TEMPLATE_CONTENT: Record<string, string> = {
${Object.entries(templates).map(([id, content]) =>
    `  "${id}": ${JSON.stringify(content)}`
).join(',\n')}
};

/**
 * Get template content by ID
 */
export function getTemplateContent(templateId: string): string | null {
  return TEMPLATE_CONTENT[templateId] || null;
}

/**
 * Get template config by ID
 */
export function getTemplateConfigById(templateId: string) {
  return TEMPLATE_CONFIG.templates.find(t => t.id === templateId) || null;
}
`;

fs.writeFileSync(outputFile, output, 'utf-8');
console.log(`\n✨ Generated: ${outputFile}`);
console.log(`   Templates: ${Object.keys(templates).length}`);
console.log(`   File size: ${(output.length / 1024).toFixed(1)} KB`);
